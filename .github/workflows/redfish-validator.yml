name: Redfish Service Validator

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
      with:
        egress-policy: audit

    - name: Checkout console repository
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

    - name: Setup environment
      run: cp .env.example .env

    - name: Start services
      run: docker compose up -d --build

    - name: Wait for services to be ready
      run: |
        echo "Waiting for application to start..."
        sleep 10
        timeout 60 bash -c 'until curl -k -f http://localhost:8181/redfish/v1 > /dev/null 2>&1; do sleep 2; done' || echo "Service may not be ready"

    - name: Checkout Redfish Service Validator
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        repository: DMTF/Redfish-Service-Validator
        path: redfish-validator

    - name: Set up Python
      uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
      with:
        python-version: '3.x'

    - name: Install Redfish Service Validator
      run: |
        cd redfish-validator
        pip install -r requirements.txt

    - name: Run Redfish Service Validator
      run: |
        cd redfish-validator
        python3 RedfishServiceValidator.py \
          -i http://localhost:8181 \
          --logdir ../validator-results \
          --debugging

    - name: Upload validation results
      if: always()
      uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
      with:
        name: redfish-validator-results
        path: validator-results/

    - name: Dump docker logs on failure
      if: failure()
      uses: jwalton/gh-docker-logs@2741064ab9d7af54b0b1ffb6076cf64c16f0220e # v2.2.2

    - name: Check validation results
      run: |
        if [ -d validator-results ]; then
          echo "Validation completed. Check artifacts for detailed results."
          ls -la validator-results/
        else
          echo "Warning: Validation results not found"
          exit 1
        fi
