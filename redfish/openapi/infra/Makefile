# Redfish API Generation Makefile
# This file contains all targets for Redfish API specification processing,
# code generation, and validation.

# Redfish API Generation Variables
MAIN_OPENAPI := ../dmtf/openapi.yaml
MERGED_OPENAPI := ../merged/redfish-openapi.yaml
GENERATED_SPEC := ../../internal/controller/http/v1/generated/spec.gen.go
GENERATED_TYPES := ../../internal/controller/http/v1/generated/types.gen.go
GENERATED_SERVER := ../../internal/controller/http/v1/generated/server.gen.go
MERGE_SCRIPT := merge-redfish-openapi.py
# Tool versions
OAPI_CODEGEN_VERSION := github.com/oapi-codegen/oapi-codegen/v2/cmd/oapi-codegen@v2.5.1

# Source YAML files in ../dmtf directory
YAML_SOURCES := $(wildcard ../dmtf/*.yaml)

# Required tools for Redfish API generation
REDFISH_REQUIRED_TOOLS := python3 go oapi-codegen swagger-cli
PYTHON_TOOLS := PyYAML

# Tool check functions
define check_tool
$(shell command -v $(1) >/dev/null 2>&1 && echo "âœ…" || echo "âŒ")
endef

define check_python_package
$(shell python3 -c "import $(1)" 2>/dev/null && echo "âœ…" || echo "âŒ")
endef

# OS check function for Ubuntu
define check_ubuntu
	@if [ ! -f /etc/os-release ]; then \
		echo "âŒ Cannot detect OS. /etc/os-release not found."; \
		echo "ğŸ’¡ Redfish API targets are only supported on Ubuntu systems."; \
		exit 1; \
	fi; \
	if ! grep -qi "ubuntu" /etc/os-release; then \
		echo "âŒ Redfish API targets are only supported on Ubuntu systems."; \
		echo "ğŸ” Current OS: $$(grep '^PRETTY_NAME=' /etc/os-release | cut -d'=' -f2 | tr -d '\"' || echo 'Unknown')"; \
		echo "ğŸ’¡ Please use an Ubuntu system to run Redfish API generation targets."; \
		exit 1; \
	fi; \
	echo "âœ… Ubuntu detected: $$(grep '^PRETTY_NAME=' /etc/os-release | cut -d'=' -f2 | tr -d '\"')"
endef

# HELP =================================================================================================================
# This will output the help for each task
.PHONY: help

help: ## Display this help screen
	@awk 'BEGIN {FS = ":.*##"; printf "\nUsage:\n  make \033[36m<target>\033[0m\n"} /^[a-zA-Z_-]+:.*?##/ { printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2 } /^##@/ { printf "\n\033[1m%s\033[0m\n", substr($$0, 5) } ' $(MAKEFILE_LIST)

##@ Redfish API Generation

rf-merge: ### Merge YAML files into single OpenAPI specification
	$(call check_ubuntu)
	@echo "ğŸ”„ Merging YAML files into single OpenAPI specification..."
	python3 $(MERGE_SCRIPT)
	@echo "âœ… Merged OpenAPI spec created: $(MERGED_OPENAPI)"
.PHONY: rf-merge

$(MERGED_OPENAPI): $(YAML_SOURCES) $(MERGE_SCRIPT)
	@echo "ğŸ”„ Merging YAML files into single OpenAPI specification..."
	python3 $(MERGE_SCRIPT)
	@echo "âœ… Merged OpenAPI spec created: $(MERGED_OPENAPI)"

rf-generate: $(GENERATED_SPEC) $(GENERATED_TYPES) $(GENERATED_SERVER) ### Generate Go server code from merged OpenAPI spec
	$(call check_ubuntu)
.PHONY: rf-generate

$(GENERATED_SPEC): $(MERGED_OPENAPI)
	$(call check_ubuntu)
	@echo "ğŸ”„ Generating OpenAPI spec Go code..."
	@mkdir -p ../../internal/controller/http/v1/generated
	oapi-codegen -generate spec -o $(GENERATED_SPEC) -package generated $(MERGED_OPENAPI)
	@echo "âœ… Generated spec code: $(GENERATED_SPEC)"

$(GENERATED_TYPES): $(MERGED_OPENAPI)
	$(call check_ubuntu)
	@echo "ğŸ”„ Generating types Go code..."
	@mkdir -p ../../internal/controller/http/v1/generated
	oapi-codegen -generate types -o $(GENERATED_TYPES) -package generated $(MERGED_OPENAPI)
	@echo "âœ… Generated types code: $(GENERATED_TYPES)"

$(GENERATED_SERVER): $(MERGED_OPENAPI)
	$(call check_ubuntu)
	@echo "ğŸ”„ Generating server Go code..."
	@mkdir -p ../../internal/controller/http/v1/generated
	oapi-codegen -generate gin,strict-server -o $(GENERATED_SERVER) -package generated $(MERGED_OPENAPI)
	@echo "âœ… Generated server code: $(GENERATED_SERVER)"

rf-deps: rf-check-tools ### Install dependencies and required tools for Redfish API
	$(call check_ubuntu)
	@echo "ğŸ”§ Installing and verifying all dependencies..."
	@$(MAKE) rf-install-missing-tools
	@echo "âœ… All dependencies installed and verified"
.PHONY: rf-deps

rf-check-tools: ### Check if all required tools are available
	$(call check_ubuntu)
	@echo "ğŸ”§ Detailed Tool Status Report"
	@echo "==============================="
	@echo ""
	@echo "Required Tools:"
	@missing_tools=""; \
	for tool in $(REDFISH_REQUIRED_TOOLS); do \
		echo -n "  $$tool: "; \
		if command -v $$tool >/dev/null 2>&1; then \
			case $$tool in \
				python3) echo "âœ… $$(python3 --version 2>&1)";; \
				go) echo "âœ… $$(go version | cut -d' ' -f3-4)";; \
				oapi-codegen) echo "âœ… $$(oapi-codegen -version 2>/dev/null || echo 'installed')";; \
				swagger-cli) echo "âœ… $$(swagger-cli --version 2>/dev/null || echo 'installed')";; \
				*) echo "âœ… installed";; \
			esac; \
		else \
			echo "âŒ Missing"; \
			missing_tools="$$missing_tools $$tool"; \
		fi; \
	done; \
	echo ""; \
	echo "Python Packages:"; \
	echo -n "  PyYAML: "; \
	if python3 -c "import yaml; print('âœ… version', yaml.__version__)" 2>/dev/null; then \
		true; \
	else \
		echo "âŒ Missing"; \
	fi; \
	echo ""; \
	if [ -n "$$missing_tools" ]; then \
		echo "âŒ Missing required tools:$$missing_tools"; \
		echo "ğŸ’¡ Run 'make rf-deps' to install missing dependencies"; \
		exit 1; \
	else \
		echo "âœ… All required tools are available!"; \
	fi
.PHONY: rf-check-tools

rf-install-missing-tools: ### Install missing tools automatically
	$(call check_ubuntu)
	@echo "ğŸ› ï¸  Installing missing tools..."

	# Check and install Go
	@if ! command -v go >/dev/null 2>&1; then \
		echo "âŒ Go not found. Please install Go first: https://golang.org/doc/install"; \
		exit 1; \
	fi

	# Check and install Python3
	@if ! command -v python3 >/dev/null 2>&1; then \
		echo "Installing Python3..."; \
		if command -v apt-get >/dev/null 2>&1; then \
			sudo apt-get update && sudo apt-get install -y python3 python3-pip; \
		elif command -v yum >/dev/null 2>&1; then \
			sudo yum install -y python3 python3-pip; \
		else \
			echo "âŒ Please install Python3 manually"; \
			exit 1; \
		fi; \
	fi

	# Install Python packages
	@if ! python3 -c "import yaml" 2>/dev/null; then \
		echo "Installing PyYAML..."; \
		pip3 install PyYAML --user 2>/dev/null || python3 -m pip install PyYAML --user; \
	fi

	# Install oapi-codegen
	@if ! command -v oapi-codegen >/dev/null 2>&1; then \
		echo "Installing oapi-codegen from $(OAPI_CODEGEN_VERSION)..."; \
		go install $(OAPI_CODEGEN_VERSION); \
	fi

	# Install swagger-cli
	@if ! command -v swagger-cli >/dev/null 2>&1; then \
		echo "Installing swagger-cli..."; \
		if command -v npm >/dev/null 2>&1; then \
			npm install -g @apidevtools/swagger-cli; \
		else \
			echo "âŒ npm not found. Please install Node.js and npm first, then run:"; \
			echo "   npm install -g @apidevtools/swagger-cli"; \
			exit 1; \
		fi; \
	fi

	@echo "âœ… All required tools installed successfully"
.PHONY: rf-install-missing-tools

rf-validate: $(MERGED_OPENAPI) ### Validate OpenAPI specification
	$(call check_ubuntu)
	@echo "ğŸ”„ Validating OpenAPI specification..."
	@if command -v swagger-cli >/dev/null 2>&1; then \
		swagger-cli validate $(MERGED_OPENAPI) && echo "âœ… OpenAPI spec is valid"; \
	else \
		echo "âš ï¸  swagger-cli not found, skipping validation"; \
		echo "ğŸ’¡ Install swagger-cli: npm install -g @apidevtools/swagger-cli"; \
	fi
.PHONY: rf-validate

rf-clean: ### Clean generated files
	@echo "ğŸ§¹ Cleaning generated files..."
	@rm -f $(GENERATED_SPEC) $(GENERATED_TYPES) $(GENERATED_SERVER) $(MERGED_OPENAPI)
	@echo "âœ… Cleaned generated files"
.PHONY: rf-clean

rf-auth: ### Add Basic Auth to OpenAPI spec and regenerate Go code
	@echo "ğŸ” Adding Basic Authentication to Redfish OpenAPI spec..."
	python3 add-basic-auth.py
	@echo "âœ… Basic Authentication added"
.PHONY: rf-auth

rf-all: rf-merge rf-generate rf-validate rf-auth ### Run all Redfish API generation steps
	@echo "âœ… All Redfish API generation steps completed"
.PHONY: rf-all

rf-metadata-generate: ### Generate metadata.xml from DMTF schemas
	@echo "ğŸ“¥ Generating metadata.xml from DMTF schemas..."
	python3 metadata-generate.py
	@echo "âœ… Metadata generation completed"
.PHONY: rf-metadata-generate
