name: Console API Tests

on:
  push:
    branches: [main, apiIntegrationTests]
  pull_request:
    branches: [main]
  workflow_dispatch:
permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Set up Go
        uses: actions/setup-go@41dfa10bad2bb2ae585af6ee5bb4d7d973ad74ed # v5.1.0
        with:
          go-version: "1.23"
      - name: Copy environment file
        run: cp .env.example .env
      - name: Build Console Application
        run: go build -o ./console-server cmd/app/main.go
      - name: Start Console Service (Docker Compose for MPS/RPS tests)
        run: docker compose up -d --build
      - name: Let Docker Spin up
        run: sleep 5
      - name: Run Console API Tests (MPS)
        continue-on-error: true
        run: docker run --network=host -v  /home/runner/work/console/console/integration-test/collections:/collections -v /home/runner/work/console/console/integration-test/results/:/results postman/newman:5.3-alpine run /collections/console_mps_apis.postman_collection.json -e /collections/console_environment.postman_environment.json --insecure --reporters cli,json,junit --reporter-json-export /results/console_mps_api_results.json --reporter-junit-export /results/console_mps_api_results_junit.xml
      - name: Run Console API Tests (RPS)
        continue-on-error: true
        run: docker run --network=host -v  /home/runner/work/console/console/integration-test/collections:/collections -v /home/runner/work/console/console/integration-test/results/:/results postman/newman:5.3-alpine run /collections/console_rps_apis.postman_collection.json -e /collections/console_environment.postman_environment.json --insecure --reporters cli,json,junit --reporter-json-export /results/console_rps_api_results.json --reporter-junit-export /results/console_rps_api_results_junit.xml
      - name: Stop Docker Compose
        run: |
          docker compose down
          sleep 5
      - name: Start Console Service (Native Go for Redfish tests)
        run: |
          mkdir -p /home/runner/work/console/console/integration-test/results
          export AUTH_DISABLED=true
          export HTTP_PORT=8181
          export APP_ENCRYPTION_KEY=$(openssl rand -hex 32)
          ./console-server > /tmp/console.log 2>&1 &
          PID=$!
          echo $PID > /tmp/console.pid
          echo "Console service started with PID $PID"
          sleep 3
      - name: Health Check
        run: |
          for i in {1..10}; do
            if curl -s -k https://localhost:8181/redfish/v1/ | grep -q "@odata.id"; then
              exit 0
            fi
            sleep 2
          done
          echo "Health check failed after 20 seconds"
          cat /tmp/console.log
          exit 1
      - name: Run Redfish API Tests
        continue-on-error: true
        id: redfish-tests
        run: docker run --network=host -v  /home/runner/work/console/console/integration-test/collections:/collections -v /home/runner/work/console/console/integration-test/results/:/results postman/newman:5.3-alpine run /collections/console_redfish_apis.postman_collection.json -e /collections/console_environment.postman_environment.json --insecure --reporters cli,json,junit --reporter-json-export /results/console_redfish_api_results.json --reporter-junit-export /results/console_redfish_api_results_junit.xml
      - name: Check Redfish Test Results
        if: always()
        run: |
          echo "Note: Some Reset Action tests may fail (backend not fully implemented)"
      - name: Stop Console Service
        if: always()
        run: |
          if [ -f /tmp/console.pid ]; then
            kill $(cat /tmp/console.pid) || true
          fi
          pkill -f "console-server" || true
      - name: Dump docker logs on failure
        if: failure()
        uses: jwalton/gh-docker-logs@2741064ab9d7af54b0b1ffb6076cf64c16f0220e # v2.2.2
      - name: Dump Console Service logs on failure
        if: failure()
        run: |
          cat /tmp/console.log || echo "No console.log found"
          cp /tmp/console.log /home/runner/work/console/console/integration-test/results/console.log || true
      - name: Upload Postman Results
        if: always()
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: api-test-results
          path: /home/runner/work/console/console/integration-test/results
